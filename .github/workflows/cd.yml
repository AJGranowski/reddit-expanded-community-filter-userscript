# This workflow is used for continuous deployment of applicable builds

name: Continuous Deployment
run-name: "Deploy ${{ github.event.workflow_run.display_title }}"

on:
  workflow_dispatch:
    inputs:
      job-id:
        description: Continuous Integration Job ID
        required: true
  workflow_run:
    workflows: [Continuous Integration]
    types: [completed]
    branches: [mainline]

jobs:
  verify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Verify
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20.3.1
        cache: "npm"

    - uses: dawidd6/action-download-artifact@v2
      with:
        run_id: ${{ github.event.workflow_run.id }}
        name: artifacts
        path: artifacts
  
    - name: "Verify the deploymenet artifacts"
      run: node verifyDeploy.js artifacts/script.user.js artifacts/script.meta.js

  deploy:
    needs: verify
    name: Deploy
    runs-on: ubuntu-latest
    # environment: production
    permissions:
      contents: write

    steps:
      - uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: artifacts
          path: artifacts
      
      - name: Get artifact script version
        run: echo "SCRIPT_VERSION=$(grep -oP '// @version \K(.+)' artifacts/script.meta.js)" >> $GITHUB_ENV

      - name: Create release tag
        run: echo "RELEASE_TAG=$(echo release-$SCRIPT_VERSION)" >> $GITHUB_ENV
      
      - name: Create release
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          artifacts: "artifacts/script.meta.js,artifacts/script.user.js"
          commit: ${{ github.event.workflow_run.head_commit.id }}
          draft: true
          name: Release ${{ env.SCRIPT_VERSION }}
          prerelease: true
          skipIfReleaseExists: true
          tag: "release-${{ env.SCRIPT_VERSION }}"
          updateOnlyUnreleased: true

# https://docs.github.com/en/rest/actions/workflow-runs#list-workflow-runs-for-a-workflow